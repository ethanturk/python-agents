version: '3.8'

# Multi-Instance Worker Deployment
# This Docker Compose file deploys multiple async workers on a single VPS,
# each worker dedicated to a specific tenant instance.
#
# Usage:
#   1. Create .env file with tenant-specific environment variables
#   2. Deploy: docker-compose -f docker-compose.workers-multi.yml up -d
#   3. Monitor: docker-compose -f docker-compose.workers-multi.yml logs -f
#   4. Scale: Add new worker service for each tenant
#
# Environment Variables Required (per tenant):
#   TENANT{N}_CLIENT_ID - Client identifier for queue isolation
#   TENANT{N}_OPENAI_API_KEY - OpenAI API key
#   TENANT{N}_OPENAI_API_BASE - OpenAI API base URL
#   TENANT{N}_OPENAI_MODEL - LLM model name
#   TENANT{N}_OPENAI_EMBEDDING_MODEL - Embedding model name
#   TENANT{N}_OPENAI_EMBEDDING_DIMENSIONS - Embedding dimensions
#   TENANT{N}_SUPABASE_URL - Supabase project URL
#   TENANT{N}_SUPABASE_KEY - Supabase anon/service key
#   TENANT{N}_AZURE_STORAGE_CONNECTION_STRING - Azure Storage connection string
#   TENANT{N}_AZURE_STORAGE_ACCOUNT_NAME - Azure Storage account name

services:
  # Worker for tenant1
  worker-tenant1:
    image: ethanturk/python-agents-worker:latest
    container_name: worker-tenant1
    pull_policy: always
    command: ["python", "main.py"]
    environment:
      CLIENT_ID: ${TENANT1_CLIENT_ID:-tenant1}
      WORKER_POLLING_INTERVAL: ${TENANT1_WORKER_POLLING_INTERVAL:-5}
      WORKER_VISIBILITY_TIMEOUT: ${TENANT1_WORKER_VISIBILITY_TIMEOUT:-30}
      WORKER_MAX_MESSAGES: ${TENANT1_WORKER_MAX_MESSAGES:-10}
      OPENAI_API_KEY: ${TENANT1_OPENAI_API_KEY}
      OPENAI_API_BASE: ${TENANT1_OPENAI_API_BASE:-https://api.openai.com/v1}
      OPENAI_MODEL: ${TENANT1_OPENAI_MODEL:-gpt-4o-mini}
      OPENAI_EMBEDDING_MODEL: ${TENANT1_OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      OPENAI_EMBEDDING_DIMENSIONS: ${TENANT1_OPENAI_EMBEDDING_DIMENSIONS:-1536}
      SUPABASE_URL: ${TENANT1_SUPABASE_URL}
      SUPABASE_KEY: ${TENANT1_SUPABASE_KEY}
      AZURE_STORAGE_CONNECTION_STRING: ${TENANT1_AZURE_STORAGE_CONNECTION_STRING}
      AZURE_STORAGE_ACCOUNT_NAME: ${TENANT1_AZURE_STORAGE_ACCOUNT_NAME}
      AZURE_STORAGE_CONTAINER_NAME: ${TENANT1_AZURE_STORAGE_CONTAINER_NAME:-documents}
      VECTOR_TABLE_NAME: ${TENANT1_VECTOR_TABLE_NAME:-documents}
    restart: unless-stopped
    networks:
      - workers

  # Worker for tenant2
  worker-tenant2:
    image: ethanturk/python-agents-worker:latest
    container_name: worker-tenant2
    pull_policy: always
    command: ["python", "main.py"]
    environment:
      CLIENT_ID: ${TENANT2_CLIENT_ID:-tenant2}
      WORKER_POLLING_INTERVAL: ${TENANT2_WORKER_POLLING_INTERVAL:-5}
      WORKER_VISIBILITY_TIMEOUT: ${TENANT2_WORKER_VISIBILITY_TIMEOUT:-30}
      WORKER_MAX_MESSAGES: ${TENANT2_WORKER_MAX_MESSAGES:-10}
      OPENAI_API_KEY: ${TENANT2_OPENAI_API_KEY}
      OPENAI_API_BASE: ${TENANT2_OPENAI_API_BASE:-https://api.openai.com/v1}
      OPENAI_MODEL: ${TENANT2_OPENAI_MODEL:-gpt-4o-mini}
      OPENAI_EMBEDDING_MODEL: ${TENANT2_OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      OPENAI_EMBEDDING_DIMENSIONS: ${TENANT2_OPENAI_EMBEDDING_DIMENSIONS:-1536}
      SUPABASE_URL: ${TENANT2_SUPABASE_URL}
      SUPABASE_KEY: ${TENANT2_SUPABASE_KEY}
      AZURE_STORAGE_CONNECTION_STRING: ${TENANT2_AZURE_STORAGE_CONNECTION_STRING}
      AZURE_STORAGE_ACCOUNT_NAME: ${TENANT2_AZURE_STORAGE_ACCOUNT_NAME}
      AZURE_STORAGE_CONTAINER_NAME: ${TENANT2_AZURE_STORAGE_CONTAINER_NAME:-documents}
      VECTOR_TABLE_NAME: ${TENANT2_VECTOR_TABLE_NAME:-documents}
    restart: unless-stopped
    networks:
      - workers

  # Worker for tenant3
  worker-tenant3:
    image: ethanturk/python-agents-worker:latest
    container_name: worker-tenant3
    pull_policy: always
    command: ["python", "main.py"]
    environment:
      CLIENT_ID: ${TENANT3_CLIENT_ID:-tenant3}
      WORKER_POLLING_INTERVAL: ${TENANT3_WORKER_POLLING_INTERVAL:-5}
      WORKER_VISIBILITY_TIMEOUT: ${TENANT3_WORKER_VISIBILITY_TIMEOUT:-30}
      WORKER_MAX_MESSAGES: ${TENANT3_WORKER_MAX_MESSAGES:-10}
      OPENAI_API_KEY: ${TENANT3_OPENAI_API_KEY}
      OPENAI_API_BASE: ${TENANT3_OPENAI_API_BASE:-https://api.openai.com/v1}
      OPENAI_MODEL: ${TENANT3_OPENAI_MODEL:-gpt-4o-mini}
      OPENAI_EMBEDDING_MODEL: ${TENANT3_OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      OPENAI_EMBEDDING_DIMENSIONS: ${TENANT3_OPENAI_EMBEDDING_DIMENSIONS:-1536}
      SUPABASE_URL: ${TENANT3_SUPABASE_URL}
      SUPABASE_KEY: ${TENANT3_SUPABASE_KEY}
      AZURE_STORAGE_CONNECTION_STRING: ${TENANT3_AZURE_STORAGE_CONNECTION_STRING}
      AZURE_STORAGE_ACCOUNT_NAME: ${TENANT3_AZURE_STORAGE_ACCOUNT_NAME}
      AZURE_STORAGE_CONTAINER_NAME: ${TENANT3_AZURE_STORAGE_CONTAINER_NAME:-documents}
      VECTOR_TABLE_NAME: ${TENANT3_VECTOR_TABLE_NAME:-documents}
    restart: unless-stopped
    networks:
      - workers

  # Worker for tenant4
  worker-tenant4:
    image: ethanturk/python-agents-worker:latest
    container_name: worker-tenant4
    pull_policy: always
    command: ["python", "main.py"]
    environment:
      CLIENT_ID: ${TENANT4_CLIENT_ID:-tenant4}
      WORKER_POLLING_INTERVAL: ${TENANT4_WORKER_POLLING_INTERVAL:-5}
      WORKER_VISIBILITY_TIMEOUT: ${TENANT4_WORKER_VISIBILITY_TIMEOUT:-30}
      WORKER_MAX_MESSAGES: ${TENANT4_WORKER_MAX_MESSAGES:-10}
      OPENAI_API_KEY: ${TENANT4_OPENAI_API_KEY}
      OPENAI_API_BASE: ${TENANT4_OPENAI_API_BASE:-https://api.openai.com/v1}
      OPENAI_MODEL: ${TENANT4_OPENAI_MODEL:-gpt-4o-mini}
      OPENAI_EMBEDDING_MODEL: ${TENANT4_OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      OPENAI_EMBEDDING_DIMENSIONS: ${TENANT4_OPENAI_EMBEDDING_DIMENSIONS:-1536}
      SUPABASE_URL: ${TENANT4_SUPABASE_URL}
      SUPABASE_KEY: ${TENANT4_SUPABASE_KEY}
      AZURE_STORAGE_CONNECTION_STRING: ${TENANT4_AZURE_STORAGE_CONNECTION_STRING}
      AZURE_STORAGE_ACCOUNT_NAME: ${TENANT4_AZURE_STORAGE_ACCOUNT_NAME}
      AZURE_STORAGE_CONTAINER_NAME: ${TENANT4_AZURE_STORAGE_CONTAINER_NAME:-documents}
      VECTOR_TABLE_NAME: ${TENANT4_VECTOR_TABLE_NAME:-documents}
    restart: unless-stopped
    networks:
      - workers

  # Worker for tenant5
  worker-tenant5:
    image: ethanturk/python-agents-worker:latest
    container_name: worker-tenant5
    pull_policy: always
    command: ["python", "main.py"]
    environment:
      CLIENT_ID: ${TENANT5_CLIENT_ID:-tenant5}
      WORKER_POLLING_INTERVAL: ${TENANT5_WORKER_POLLING_INTERVAL:-5}
      WORKER_VISIBILITY_TIMEOUT: ${TENANT5_WORKER_VISIBILITY_TIMEOUT:-30}
      WORKER_MAX_MESSAGES: ${TENANT5_WORKER_MAX_MESSAGES:-10}
      OPENAI_API_KEY: ${TENANT5_OPENAI_API_KEY}
      OPENAI_API_BASE: ${TENANT5_OPENAI_API_BASE:-https://api.openai.com/v1}
      OPENAI_MODEL: ${TENANT5_OPENAI_MODEL:-gpt-4o-mini}
      OPENAI_EMBEDDING_MODEL: ${TENANT5_OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      OPENAI_EMBEDDING_DIMENSIONS: ${TENANT5_OPENAI_EMBEDDING_DIMENSIONS:-1536}
      SUPABASE_URL: ${TENANT5_SUPABASE_URL}
      SUPABASE_KEY: ${TENANT5_SUPABASE_KEY}
      AZURE_STORAGE_CONNECTION_STRING: ${TENANT5_AZURE_STORAGE_CONNECTION_STRING}
      AZURE_STORAGE_ACCOUNT_NAME: ${TENANT5_AZURE_STORAGE_ACCOUNT_NAME}
      AZURE_STORAGE_CONTAINER_NAME: ${TENANT5_AZURE_STORAGE_CONTAINER_NAME:-documents}
      VECTOR_TABLE_NAME: ${TENANT5_VECTOR_TABLE_NAME:-documents}
    restart: unless-stopped
    networks:
      - workers



networks:
  workers:
    driver: bridge
